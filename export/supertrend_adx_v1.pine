//@version=6
strategy("SuperTrend + ADX Momentum v1", overlay=true, margin_long=100, margin_short=100,
         default_qty_type=strategy.percent_of_equity, default_qty_value=90,
         commission_type=strategy.commission.percent, commission_value=0.0,
         slippage=0, fill_orders_on_standard_ohlc=true)

// ══════════════════════════════════════════════════════════
// Generated by Trading Backtest Engine
// Strategy: SuperTrend + ADX + RSI + EMA Momentum
// Best performer: +$35,401 (+59%) on MSTZ, +$7,204 (+12%) on MSTR
// Trades LONG and SHORT | Tight 1x ATR stop / 2.5x ATR target
// ══════════════════════════════════════════════════════════

// ── Inputs ──────────────────────────────────────────────
grp_st    = "SuperTrend"
st_len    = input.int(7,    "SuperTrend Length",   minval=1, maxval=50,  group=grp_st)
st_mult   = input.float(2.5,"SuperTrend Multiplier", minval=0.5, maxval=10, step=0.1, group=grp_st)

grp_filt  = "Filters"
adx_len   = input.int(14,   "ADX Length",          minval=5, maxval=50,  group=grp_filt)
adx_min   = input.int(20,   "ADX Min Threshold",   minval=5, maxval=60,  group=grp_filt)
rsi_len   = input.int(9,    "RSI Length",           minval=2, maxval=30,  group=grp_filt)
rsi_long  = input.int(50,   "RSI Long Min",         minval=30, maxval=70, group=grp_filt)
rsi_short = input.int(50,   "RSI Short Max",        minval=30, maxval=70, group=grp_filt)
ema_len   = input.int(50,   "Trend EMA Length",     minval=10, maxval=200, group=grp_filt)

grp_risk  = "Risk Management"
atr_len   = input.int(10,   "ATR Length",           minval=5, maxval=30,  group=grp_risk)
atr_sl    = input.float(1.0,"ATR Stop Multiplier",  minval=0.5, maxval=5, step=0.1, group=grp_risk)
atr_tp    = input.float(2.5,"ATR Target Multiplier",minval=1.0, maxval=10, step=0.1, group=grp_risk)

grp_sess  = "Session Filter"
use_sess  = input.bool(true, "Use Session Filter",  group=grp_sess)
sess_start= input.session("0930-1545", "Trading Session (Exchange TZ)", group=grp_sess)

// ── Indicators ──────────────────────────────────────────
// SuperTrend
[st_value, st_dir] = ta.supertrend(st_mult, st_len)

// ADX + DI
[di_plus, di_minus, adx_val] = ta.dmi(adx_len, adx_len)

// RSI
rsi_val = ta.rsi(close, rsi_len)

// ATR for stops/targets
atr_val = ta.atr(atr_len)

// Trend EMA
trend_ema = ta.ema(close, ema_len)

// ── Session Filter ──────────────────────────────────────
in_session = use_sess ? not na(time(timeframe.period, sess_start)) : true

// ── SuperTrend Direction Detection ──────────────────────
// st_dir: -1 = bullish (price above SuperTrend), +1 = bearish (price below)
// NOTE: TradingView's ta.supertrend direction is OPPOSITE to our engine:
//   TV: -1 = bullish (uptrend), +1 = bearish (downtrend)
st_bullish = st_dir < 0
st_bearish = st_dir > 0

// Detect direction flips
st_flipped_bull = st_bullish and not st_bullish[1]
st_flipped_bear = st_bearish and not st_bearish[1]

// ── Entry Conditions ────────────────────────────────────
trending = adx_val > adx_min

// Price above/below trend EMA
above_ema = close > trend_ema
below_ema = close < trend_ema

// Bullish candle confirmation (relaxed on flip)
bullish_candle = close > open or st_flipped_bull
bearish_candle = close < open or st_flipped_bear

// LONG: SuperTrend bullish + ADX trending + RSI > 50 + (above EMA or flip) + bullish candle
long_cond = st_bullish and trending and rsi_val > rsi_long and bullish_candle and (above_ema or st_flipped_bull) and in_session

// SHORT: SuperTrend bearish + ADX trending + RSI < 50 + (below EMA or flip) + bearish candle
short_cond = st_bearish and trending and rsi_val < rsi_short and bearish_candle and (below_ema or st_flipped_bear) and in_session

// ── Exit Conditions ─────────────────────────────────────
// Exit on SuperTrend flip against position
long_exit_flip  = st_bearish and strategy.position_size > 0
short_exit_flip = st_bullish and strategy.position_size < 0

// Exit at end of session
eod_exit = use_sess and not in_session and strategy.position_size != 0

// ── Stop Loss & Take Profit ─────────────────────────────
stop_dist   = atr_val * atr_sl
target_dist = atr_val * atr_tp

long_stop   = close - stop_dist
long_target = close + target_dist
short_stop  = close + stop_dist
short_target= close - target_dist

// ── Strategy Execution ──────────────────────────────────
// Long entry
if long_cond and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", "Long", stop=long_stop, limit=long_target)

// Short entry
if short_cond and strategy.position_size == 0
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", "Short", stop=short_stop, limit=short_target)

// Exit on SuperTrend flip
if long_exit_flip
    strategy.close("Long", comment="ST Flip Bear")
if short_exit_flip
    strategy.close("Short", comment="ST Flip Bull")

// End of day exit
if eod_exit
    strategy.close_all(comment="End of Session")

// ── Plots ───────────────────────────────────────────────
// SuperTrend line
st_color = st_bullish ? color.new(color.green, 0) : color.new(color.red, 0)
plot(st_value, "SuperTrend", color=st_color, linewidth=2)

// Trend EMA
plot(trend_ema, "EMA 50", color=color.new(color.gray, 50), linewidth=1)

// Entry markers
plotshape(long_cond and strategy.position_size == 0, "Long Signal", shape.triangleup,
          location.belowbar, color.new(color.green, 0), size=size.small)
plotshape(short_cond and strategy.position_size == 0, "Short Signal", shape.triangledown,
          location.abovebar, color.new(color.red, 0), size=size.small)

// Background: in session
bgcolor(in_session ? na : color.new(color.gray, 95), title="Out of Session")

// ADX info label
adx_color = trending ? color.green : color.gray
plotchar(trending and (st_flipped_bull or st_flipped_bear), "ST Flip", "◆",
         location.top, color=color.new(color.yellow, 0), size=size.tiny)

// ── Info Table ──────────────────────────────────────────
var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(infoTable, 0, 0, "SuperTrend", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, st_bullish ? "▲ BULL" : "▼ BEAR", text_color=st_bullish ? color.green : color.red, text_size=size.small)
    table.cell(infoTable, 0, 1, "ADX", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(adx_val, "#.0") + (trending ? " ✓" : " ✗"), text_color=trending ? color.green : color.red, text_size=size.small)
    table.cell(infoTable, 0, 2, "RSI", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(rsi_val, "#.0"), text_color=rsi_val > 50 ? color.green : color.red, text_size=size.small)
    table.cell(infoTable, 0, 3, "ATR", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(atr_val, "#.00"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 4, "R:R", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, "1:" + str.tostring(atr_tp/atr_sl, "#.0"), text_color=color.yellow, text_size=size.small)
